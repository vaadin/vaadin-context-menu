<link rel="import" href="../../vaadin-item/vaadin-item.html">
<link rel="import" href="../../vaadin-list-box/vaadin-list-box.html">

<script>
  window.Vaadin = window.Vaadin || {};
  window.Vaadin.ContextMenu = window.Vaadin.ContextMenu || {};

  /**
   * @polymerMixin
   */
  Vaadin.ContextMenu.ItemsMixin = superClass => class ItemsMixin extends superClass {

    static get properties() {
      return {
        items: Array
      };
    }

    ready() {
      super.ready();

      // Overlay's outside click listener doesn't work with modeless
      // overlays (submenus) so we need additional logic for it
      this.__itemsOutsideClickListener = e => {
        if (!e.composedPath().find(el => el.localName === 'vaadin-context-menu-overlay')) {
          this.dispatchEvent(new CustomEvent('items-outside-click'));
        }
      };
      this.addEventListener('items-outside-click', e => this.items && this.close());
    }

    connectedCallback() {
      super.connectedCallback();
      document.addEventListener('click', this.__itemsOutsideClickListener);
    }

    disconnectedCallback() {
      super.disconnectedCallback();
      document.removeEventListener('click', this.__itemsOutsideClickListener);
    }

    __openSubMenu(subMenu, itemElement) {
      subMenu.items = itemElement._item.children;
      subMenu.listenOn = itemElement;

      const itemRect = itemElement.getBoundingClientRect();
      let x;
      const y = itemRect.top;
      if (document.documentElement.clientWidth - itemRect.right > itemRect.width) {
        // There's room on the right side
        x = itemRect.right;
      } else {
        // Open on the left side
        x = itemRect.left - itemRect.width;
      }

      itemElement.dispatchEvent(new CustomEvent('opensubmenu', {detail: {
        x, y, children: itemElement._item.children
      }}));
    }

    __itemsRenderer(root, menu, context) {
      this.__initMenu(root, menu);

      const listBox = root.querySelector('vaadin-list-box');
      const subMenu = root.querySelector('vaadin-context-menu');

      listBox.innerHTML = '';
      listBox.selected = null;

      const items = Array.from(context.detail.children || menu.items);

      items.forEach(item => {
        let component;
        if (item.component instanceof HTMLElement) {
          component = item.component;
        } else {
          component = document.createElement(item.component || 'vaadin-item');
        }
        component.classList.add('vaadin-menu-item');
        component._item = item;

        if (item.label) {
          component.textContent = item.label;
        }

        if (item.selected) {
          component.setAttribute('menu-item-selected', '');
        } else {
          component.removeAttribute('menu-item-selected');
        }

        component.disabled = item.disabled;
        component.addEventListener('mouseover', e => subMenu.close());
        component.addEventListener('keydown', e => {
          if (e.keyCode === 37 || e.keyCode === 27) {
            menu.close();
            menu.listenOn.focus();
          }
        });

        if (item.children && item.children.length) {
          component.classList.add('vaadin-context-menu-parent-item');
          const openSubMenu = this.__openSubMenu.bind(this, subMenu, component);
          component.addEventListener('mouseover', openSubMenu);
          component.addEventListener('keydown', e => e.keyCode === 39 && openSubMenu());
        }

        listBox.appendChild(component);
      });
    }

    __initMenu(root, menu) {
      if (!root.firstElementChild) {
        root.innerHTML = `
          <vaadin-list-box></vaadin-list-box>
          <vaadin-context-menu hidden></vaadin-context-menu>
        `;
        const listBox = root.querySelector('vaadin-list-box');
        const subMenu = root.querySelector('vaadin-context-menu');
        subMenu.$.overlay.modeless = true;
        subMenu.openOn = 'opensubmenu';

        menu.addEventListener('opened-changed', e => !e.detail.value && subMenu.close());

        listBox.addEventListener('selected-changed', e => {
          if (Number.isInteger(e.detail.value)) {
            const item = e.target.items[e.detail.value]._item;
            const detail = {value: item};
            menu.dispatchEvent(new CustomEvent('item-selected', {detail}));
          }
        });

        subMenu.addEventListener('item-selected', e => {
          menu.dispatchEvent(new CustomEvent('item-selected', {detail: e.detail}));
          menu.close();
        });
      }
    }

  };
</script>
