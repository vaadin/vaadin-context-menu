<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
    <script src="../../../@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>
    <script src="../../../wct-browser-legacy/browser.js"></script>
    <script type="module" src="../../../@polymer/iron-test-helpers/iron-test-helpers.js"></script>
    <script type="module" src="../../../@polymer/test-fixture/test-fixture.js"></script>
    <script type="module" src="./external-imports.js"></script>
    <script type="module" src="../vaadin-context-menu.js"></script>
    <script type="module" src="./not-animated-styles.js"></script>
    <script src="../../../@polymer/iron-test-helpers/mock-interactions.js" type="module"></script>
    <script src="./common.js"></script>
  </head>
  <body>
    <test-fixture id="default">
      <template>
        <vaadin-context-menu>
          <template>
            <vaadin-list-box id="menu">
              <vaadin-item>item1</vaadin-item>
              <vaadin-item>item2</vaadin-item>
              <vaadin-item>item3</vaadin-item>
            </vaadin-list-box>
          </template>
        </vaadin-context-menu>
      </template>
    </test-fixture>

    <script type="module">
import '@polymer/iron-test-helpers/iron-test-helpers.js';
import '@polymer/test-fixture/test-fixture.js';
import './external-imports.js';
import '../vaadin-context-menu.js';
import './not-animated-styles.js';
import { afterNextRender } from '@polymer/polymer/lib/utils/render-status.js';
import { timeOut } from '@polymer/polymer/lib/utils/async.js';
describe('overlay', () => {

  let menu;

  beforeEach(() => {
    menu = fixture('default');
  });

  describe('selection', () => {

    it('should close on item tap', done => {
      listenOnce(menu.$.overlay, 'vaadin-overlay-open', () => {
        const listBox = menu.$.overlay.content.querySelector('#menu');
        afterNextRender(listBox, () => {
          MockInteractions.tap(listBox.items[0]);
          expect(menu.opened).to.eql(false);
          done();
        });
      });

      menu._setOpened(true);
    });

    it('should close on keyboard selection', done => {
      listenOnce(menu.$.overlay, 'vaadin-overlay-open', () => {
        setTimeout(() => {
          listenOnce(menu, 'opened-changed', () => {
            done();
          });

          const item = menu.$.overlay.content.querySelector('#menu vaadin-item');
          MockInteractions.pressAndReleaseKeyOn(item, 13, [], 'Enter');
        }, 10);
      });

      menu._setOpened(true);
    });

    it('should focus the child element', done => {
      listenOnce(menu.$.overlay, 'vaadin-overlay-open', () => {
        timeOut.run(() => {
          const item = menu.$.overlay.content.querySelector('#menu vaadin-item');
          expect(document.activeElement).to.eql(item);
          done();
        });
      });

      menu._setOpened(true);
    });

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    (isIOS ? it.skip : it)('should focus the child element on `contextmenu` event', done => {
      listenOnce(menu.$.overlay, 'vaadin-overlay-open', () => {
        timeOut.run(() => {
          const item = menu.$.overlay.content.querySelector('#menu vaadin-item');
          expect(document.activeElement).to.eql(item);
          done();
        });
      });

      fire(menu, 'contextmenu');
    });
  });
});
</script>

  </body>
</html>
