<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/shadow.html">
<link rel="import" href="vaadin-context-menu-overlay.html">
<link rel="import" href="long-touch-gesture.html">

<dom-module id="vaadin-context-menu">
  <template>
    <style>
      :host {
        display: block;
      }

      #overlay {
        @apply(--shadow-elevation-6dp);
      }

      :host ::content paper-menu {
        width: calc(64px * 4);
        padding: 16px 0;
      }

      :host ::content paper-item,
      :host ::content paper-item-body {
        min-height: 32px !important;
        padding: 0 24px;
      }
    </style>
    <vaadin-context-menu-overlay id="overlay" on-iron-overlay-opened="_focusChild" opened="{{opened}}">
      <div class="dropdown-content">
        <content></content>
      </div>
    </vaadin-context-menu-overlay>

  </template>
  <script>
    Polymer({
      is: 'vaadin-context-menu',

      properties: {
        target: {
          type: Object,
          observer: '_targetChanged'
        },
        targetSelector: {
          type: String
        },
        opened: {
          type: Boolean,
          value: false,
          notify: true
        },
        noClose: {
          type: Boolean,
          value: false
        }
      },

      listeners: {
        click: '_onClick',
        'iron-select': '_onSelect',
        'iron-deselect': '_onDeselect'
      },

      observers: [
        '_targetSelectorChanged(isAttached, targetSelector)'
      ],

      _onSelect: function(e) {
        e.detail.item.fire('item-select', e.target.indexOf(e.detail.item));
      },

      _onDeselect: function(e) {
        e.detail.item.fire('item-deselect', e.target.indexOf(e.detail.item));
      },

      attached: function() {
        if (!this.target) {
          this.target = this.parentElement;
        }
      },

      _focusChild: function() {
        var child = Polymer.dom(this).queryDistributedElements('*')[0];
        if (child) {
          child.focus();
        }
      },

      open: function() {
        this.opened = true;
      },

      close: function() {
        this.opened = false;
      },

      _onClick: function() {
        if (!this.noClose)Â {
          this.close();
        }
      },

      _targetChanged: function(target, oldTarget) {
        if (oldTarget) {
          oldTarget.style.webkitUserSelect = '';
          this.unlisten(oldTarget, 'long-touch', '_onContextMenu');
          this.unlisten(oldTarget, 'contextmenu', '_onContextMenu');
        }
        if (target) {
          target.style.webkitUserSelect = 'none';
          this.listen(target, 'long-touch', '_onContextMenu');
          this.listen(target, 'contextmenu', '_onContextMenu');
        }
      },

      _onContextMenu: function(e) {
        e.preventDefault();

        // some mobile browsers like iOS Safari seem to get the client X and Y
        // wrong (always 0,0) unless we set them after a short delay.
        // could be removed for desktop browsers if needed.
        this.$.overlay.style.visibility = 'hidden';

        this.opened = true;

        this.debounce('opening', function() {
          this.$.overlay.resetFit();
          this.$.overlay.x = e.clientX || e.detail.clientX;
          this.$.overlay.y = e.clientY || e.detail.clientY;
          this.$.overlay.style.visibility = '';
          // need to explicitly focus because overlay is still hidden at the time
          // `iron-overlay-opened` event is fired.
          this._focusChild();
        }, 100);

      },

      _targetSelectorChanged: function(isAttached, targetSelector) {
        if (isAttached) {
          var host = Polymer.dom(this).parentNode;
          // TODO: use querySelectorAll and use target as array for multi-targeting?
          this.target = Polymer.dom(host).querySelector(targetSelector);
        }
      }
    });
  </script>
</dom-module>
