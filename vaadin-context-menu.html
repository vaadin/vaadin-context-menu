<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/shadow.html">
<link rel="import" href="vaadin-context-menu-overlay.html">

<dom-module id="vaadin-context-menu">
  <template>
    <style>
      :host {
        display: block;
      }

      #overlay {
        @apply(--shadow-elevation-6dp);
      }

      :host ::content paper-menu {
        width: calc(64px * 4);
        padding: 16px 0;
      }

      :host ::content paper-item,
      :host ::content paper-item-body {
        min-height: 32px !important;
        padding: 0 24px;
      }
    </style>
    <vaadin-context-menu-overlay id="overlay" on-iron-overlay-opened="_onOverlayOpened" opened="{{opened}}">
      <div class="dropdown-content">
        <content></content>
      </div>
    </vaadin-context-menu-overlay>

  </template>
  <script>
    Polymer({
      is: 'vaadin-context-menu',

      properties: {

        /**
         * The target element that's listened to for context menu opening events.
         * By default the vaadin-context-menu listens to the target's 'contextmenu'
         * events.
         * @type {!Element}
         */
        target: {
          type: Object,
          observer: '_targetChanged'
        },

        /**
         * A convencience property for selecting the target element using a CSS
         * selector. The target element must be a descendant of the
         * vaadin-context-menu's parent node while the property is changed.
         */
        targetSelector: {
          type: String
        },

        /**
         * True if the overlay is currently displayed.
         */
        opened: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * Event to listen for closing the context menu.
         */
        closeOn: {
          type: String,
          value: 'click',
          observer: '_closeOnChanged'
        }
      },

      listeners: {
        'iron-select': '_onSelect',
        'iron-deselect': '_onDeselect'
      },

      observers: [
        '_targetSelectorChanged(isAttached, targetSelector)'
      ],

      _onSelect: function(e) {
        e.detail.item.fire('item-select', e.target.indexOf(e.detail.item));
      },

      _onDeselect: function(e) {
        e.detail.item.fire('item-deselect', e.target.indexOf(e.detail.item));
      },

      attached: function() {
        if (!this.target) {
          this.target = this.parentElement;
        }
      },

      _onOverlayOpened: function() {
        var child = Polymer.dom(this).queryDistributedElements('*')[0];
        if (child) {
          child.focus();
        }
      },

      _closeOnChanged: function(closeOn, oldCloseOn) {
        if (oldCloseOn) {
          this.unlisten(this, oldCloseOn, 'close');
        }
        if (closeOn) {
          this.listen(this, closeOn, 'close');
        }
      },

      /**
       * Open the overlay.
       */
      open: function() {
        this.opened = true;
      },

      /**
       * Close the overlay.
       */
      close: function() {
        this.opened = false;
      },

      _targetChanged: function(target, oldTarget) {
        if (oldTarget) {
          this.unlisten(oldTarget, 'contextmenu', '_onContextMenu');
        }
        if (target) {
          this.listen(target, 'contextmenu', '_onContextMenu');
        }
      },

      _onContextMenu: function(e) {
        e.preventDefault();
        this.$.overlay.resetFit();
        this.$.overlay.x = e.clientX;
        this.$.overlay.y = e.clientY;
        this.opened = true;
      },

      _targetSelectorChanged: function(isAttached, targetSelector) {
        if (isAttached) {
          var host = Polymer.dom(this).parentNode;
          // TODO: use querySelectorAll and use target as array for multi-targeting?
          this.target = Polymer.dom(host).querySelector(targetSelector);
        }
      }
    });
  </script>
</dom-module>
